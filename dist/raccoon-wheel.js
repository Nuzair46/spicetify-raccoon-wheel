!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var c,r,s,d,u,p,m,e,t,n,l,a,f,o;r=Object.create,s=Object.defineProperty,d=Object.getOwnPropertyDescriptor,u=Object.getOwnPropertyNames,p=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty,n=(e=(e,t)=>function(){return t||(0,e[u(e)[0]])((t={exports:{}}).exports,t),t.exports})({"external-global-plugin:react-dom"(e,t){t.exports=Spicetify.ReactDOM}}),l=(t=(e,t,n)=>{n=null!=e?r(p(e)):{};var a=!t&&e&&e.__esModule?n:s(n,"default",{value:e,enumerable:!0}),o=e,i=void 0,l=void 0;if(o&&"object"==typeof o||"function"==typeof o)for(let e of u(o))m.call(a,e)||e===i||s(a,e,{get:()=>o[e],enumerable:!(l=d(o,e))||l.enumerable});return a})(e({"external-global-plugin:react"(e,t){t.exports=Spicetify.React}})()),a=t(n()),f=new class{constructor(e,t,n={}){this.name=e,this.settingsId=t,this.initialSettingsFields=n,this.settingsFields=this.initialSettingsFields,this.setRerender=null,this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{"button"!==t.type&&void 0===this.getFieldValue(e)&&this.setFieldValue(e,t.defaultValue)});!Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=Spicetify.Platform.History.listen(e=>{"/preferences"===e.pathname&&this.render()}),"/preferences"===Spicetify.Platform.History.location.pathname&&await this.render()},this.rerender=()=>{this.setRerender&&this.setRerender(Math.random())},this.render=async()=>{for(;!document.getElementById("desktop.settings.selectLanguage");){if("/preferences"!==Spicetify.Platform.History.location.pathname)return;await new Promise(e=>setTimeout(e,100))}var e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[spcr-settings] settings container not found");let t=Array.from(e.children).find(e=>e.id===this.settingsId);t?console.log(t):((t=document.createElement("div")).id=this.settingsId,e.appendChild(t)),a.default.render(l.default.createElement(this.FieldsContainer,null),t)},this.addButton=(e,t,n,a,o)=>{this.settingsFields[e]={type:"button",description:t,value:n,events:{onClick:a,...o}}},this.addInput=(e,t,n,a,o,i)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:n,inputType:o,events:{onChange:a,...i}}},this.addHidden=(e,t)=>{this.settingsFields[e]={type:"hidden",defaultValue:t}},this.addToggle=(e,t,n,a,o)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:n,events:{onChange:a,...o}}},this.addDropDown=(e,t,n,a,o,i)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:n[a],options:n,events:{onSelect:o,...i}}},this.getFieldValue=e=>JSON.parse(Spicetify.LocalStorage.get(this.settingsId+"."+e)||"{}")?.value,this.setFieldValue=(e,t)=>{Spicetify.LocalStorage.set(this.settingsId+"."+e,JSON.stringify({value:t}))},this.FieldsContainer=()=>{var[e,t]=(0,l.useState)(0);return this.setRerender=t,l.default.createElement("div",{className:"x-settings-section",key:e},l.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([e,t])=>l.default.createElement(this.Field,{nameId:e,field:t})))},this.Field=n=>{var e=this.settingsId+"."+n.nameId;let t;if(t="button"===n.field.type?n.field.value:this.getFieldValue(n.nameId),"hidden"===n.field.type)return l.default.createElement(l.default.Fragment,null);const[a,o]=(0,l.useState)(t),i=e=>{void 0!==e&&(o(e),this.setFieldValue(n.nameId,e))};return l.default.createElement("div",{className:"x-settings-row"},l.default.createElement("div",{className:"x-settings-firstColumn"},l.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:e},n.field.description||"")),l.default.createElement("div",{className:"x-settings-secondColumn"},"input"===n.field.type?l.default.createElement("input",{className:"x-settings-input",id:e,dir:"ltr",value:a,type:n.field.inputType||"text",...n.field.events,onChange:e=>{i(e.currentTarget.value);var t=n.field.events?.onChange;t&&t(e)}}):"button"===n.field.type?l.default.createElement("span",null,l.default.createElement("button",{id:e,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...n.field.events,onClick:e=>{i();var t=n.field.events?.onClick;t&&t(e)},type:"button"},a)):"toggle"===n.field.type?l.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},l.default.createElement("input",{id:e,className:"x-toggle-input",type:"checkbox",checked:a,...n.field.events,onClick:e=>{i(e.currentTarget.checked);var t=n.field.events?.onClick;t&&t(e)}}),l.default.createElement("span",{className:"x-toggle-indicatorWrapper"},l.default.createElement("span",{className:"x-toggle-indicator"}))):"dropdown"===n.field.type?l.default.createElement("select",{className:"main-dropDown-dropDown",id:e,...n.field.events,onChange:e=>{i(n.field.options[e.currentTarget.selectedIndex]);var t=n.field.events?.onChange;t&&t(e)}},n.field.options.map((e,t)=>l.default.createElement("option",{selected:e===a,value:t+1},e))):l.default.createElement(l.default.Fragment,null)))}}}("Raccoon-Wheel Settings","raccoonwheel-settings"),o=async function(){for(var e;null==(e=null==Spicetify?void 0:Spicetify.Player)||!e.addEventListener||null==Spicetify||!Spicetify.getAudioData;)await new Promise(e=>setTimeout(e,100));console.log("[Raccoon-Wheel] Extension loaded.");let a,o=(f.addInput("raccoonwheel-webm-link","Custom webM video URL (Link does not work if no video shows)",""),f.addInput("raccoonwheel-webm-bpm","Custom default BPM of webM video (Example: 213)",""),f.addDropDown("raccoonwheel-webm-position","Position where webM video should be rendered",["Bottom","Main"],1),f.addDropDown("raccoonwheel-webm-bpm-method","Method to calculate better BPM for slower songs",["Track BPM","Danceability, Energy and Track BPM"],1),f.addDropDown("raccoonwheel-webm-bpm-method-faster-songs","Method to calculate better BPM for faster songs",["Track BPM","Danceability, Energy and Track BPM"],1),f.addInput("raccoonwheel-webm-position-left-size","Size of webM video on the left library (Only works for left library, Default: 100)",""),f.addButton("raccoonwheel-reload","Reload custom values","Save and reload",()=>{y()}),f.pushSettings(),y(),Spicetify.Player.addEventListener("onplaypause",async()=>{var e=performance.now(),t=Spicetify.Player.getProgress();i(e,o=t)}),0);Spicetify.Player.addEventListener("onprogress",async()=>{var e=performance.now(),t=Spicetify.Player.getProgress();500<=Math.abs(t-o)&&i(e,t),o=t}),Spicetify.Player.addEventListener("songchange",async()=>{var e,t=performance.now();o=Spicetify.Player.getProgress();const n=document.getElementById("raccoonwheel-webm");n?(a=await g(),console.log("[Raccoon-Wheel] Audio data fetched:",a),a&&a.beats&&0<a.beats.length?(e=a.beats[0].start,n.playbackRate=await h(a),t=performance.now()-t,e=Math.max(0,1e3*e-t),setTimeout(()=>{n.currentTime=0,n.play()},e)):(n.playbackRate=await h(a),n.currentTime=0,n.play())):(y(),console.error("[Raccoon-Wheel] Video element not found. Recreating..."))})},(async()=>{await o()})();async function h(n){let a=Number(f.getFieldValue("raccoonwheel-webm-bpm"));if(console.log(a),a=a||130,n&&null!=n&&n.track){n=null==(n=null==n?void 0:n.track)?void 0:n.tempo;let e=n,t=("Track BPM"!==f.getFieldValue("raccoonwheel-webm-bpm-method")&&(console.log("[Raccoon-Wheel] Using danceability, energy and track BPM to calculate better BPM"),e=await w(n),console.log("[Raccoon-Wheel] Better BPM:",e)),1);return e&&(t=e/a),console.log("[Raccoon-Wheel] Track BPM:",n),console.log("[Raccoon-Wheel] raccoon jam synchronized, playback rate set to:",t),t}return console.warn("[Raccoon-Wheel] BPM data not available for this track, raccoon will not be jamming accurately :("),1}async function g(t=200,n=10){try{return await Spicetify.getAudioData()}catch(e){if("object"==typeof e&&null!==e&&"message"in e){if(e.message.includes("Cannot read properties of undefined")&&0<n)return console.log("[Raccoon-Wheel] Retrying to fetch audio data..."),await new Promise(e=>setTimeout(e,t)),g(t,n-1)}else console.warn("[Raccoon-Wheel] Error fetching audio data: "+e);return null}}async function i(e,t){const n=document.getElementById("raccoonwheel-webm");var a;n?Spicetify.Player.isPlaying()?(t/=1e3,c&&c.beats?((a=c.beats.find(e=>e.start>t))?(e=performance.now()-e,a=Math.max(0,1e3*(a.start-t)-e),setTimeout(()=>{n.currentTime=0,n.play()},a)):(n.currentTime=0,n.play()),console.log("[Raccoon-Wheel] Resynchronized to nearest beat")):(n.currentTime=0,n.play())):n.pause():(y(),console.error("[Raccoon-Wheel] Video element not found. Recreating..."))}async function y(){try{let e=Number(f.getFieldValue("raccoonwheel-webm-position-left-size"));e=e||100;var n=`width: ${e}%; position: absolute; pointer-events: none; z-index: 10;`,a=f.getFieldValue("raccoonwheel-webm-position"),o="Bottom"===a?"width: 56px; height: 56px; position: absolute; z-index: 10;  pointer-events: none; left: 0;":n,i=await async function(e,t=50,n=100){let a=0;for(;a<t;){var o=document.querySelector(e);if(o)return o;await new Promise(e=>setTimeout(e,n)),a++}throw new Error(`Element ${e} not found after ${t} attempts.`)}("Bottom"===a?".main-nowPlayingWidget-coverArt":".cover-art-auto-height"),l=document.getElementById("raccoonwheel-webm");l&&l.remove();let t=String(f.getFieldValue("raccoonwheel-webm-link"));t=t||"https://github.com/Nuzair46/spicetify-raccoon-wheel/raw/main/resources/pedro.webm";var r,s=document.createElement("video");s.setAttribute("loop","true"),s.setAttribute("autoplay","true"),s.setAttribute("muted","true"),s.src=t,s.id="raccoonwheel-webm",s.style.cssText=o,c=await g(),s.playbackRate=await h(c),"Bottom"===a?(r=i.firstChild).insertBefore(s,r.firstChild):i.insertBefore(s,i.firstChild),Spicetify.Player.isPlaying()?s.play():s.pause()}catch(e){console.error("[Raccoon-Wheel] Could not create raccoon-wheel video element: ",e)}}async function w(e){var t,n;let a=e;try{var o,i,l,r,s=null==(n=null==(t=Spicetify.Player.data)?void 0:t.item)?void 0:n.uri;s?(o=s.split(":")[2],i=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/audio-features/"+o),l=Math.round(100*i.danceability),r=Math.round(100*i.energy),a=function(e,t,n){let a=.9,o=.6,i=.6;var l=n/100,e=e/100,t=t/100;e<.5&&(a*=e);t<.5&&(o*=t);l<.8&&(i=.9);e=(e*a+t*o+l*i)/(1-a+1-o+i);let r=100*e;console.log({danceabilityWeight:a,energyWeight:o,currentBPM:n,weightedAverage:e,betterBPM:r,bpmWeight:i});t="Track BPM"!==f.getFieldValue("raccoonwheel-webm-bpm-method-faster-songs");r>n&&(r=t?(r+n)/2:n);r<n&&(r=Math.max(r,70));return r}(l,r,e)):setTimeout(w,200)}catch(e){console.error("[Raccoon-Wheel] Could not get audio features: ",e)}finally{return a}}}();